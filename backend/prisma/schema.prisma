// Prisma schema for shin-travelin
// NOTE: No ON DELETE CASCADE is used (requirements: history must be preserved). All integrity cleanup (e.g., Draft TTL) is handled in services/cron.
// NOTE: Prisma 7 requires datasource.url to be configured via prisma.config.ts; keep datasource here provider-only.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum DraftStatus {
  ACTIVE
  EXPIRED
}

enum GenerationJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum Weather {
  SUNNY
  RAINY
  CLOUDY
  UNKNOWN
}

enum DayScenario {
  SUNNY
  RAINY
}

/// User accounts; owns Drafts and Itineraries (requirements FR/AR auth baseline).
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  displayName  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  drafts      Draft[]
  itineraries Itinerary[]
}

/// Draft captures pre-generation input snapshot; TTL managed externally (db-structure.md §2.2, requirements DB-4).
model Draft {
  id           String      @id @default(uuid())
  userId       String
  origin       String
  destinations String[]
  startDate    DateTime
  endDate      DateTime
  budget       Int
  purposes     String[]
  memo         String?
  status       DraftStatus @default(ACTIVE)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user            User            @relation(fields: [userId], references: [id])
  companionDetail CompanionDetail?
  generationJobs  GenerationJob[]
  itineraries     Itinerary[]

  // NOTE: CHECK(startDate <= endDate) is enforced in service layer (Prisma lacks portable CHECK DDL).
  // Index for user-scoped listing and TTL scans (db-structure.md indexes).
  @@index([userId])
  @@index([status, createdAt])
}

/// CompanionDetail holds per-draft companion counts; 1:1 with Draft (db-structure.md §2.3).
model CompanionDetail {
  id          String   @id @default(uuid())
  draftId     String   @unique
  adultMale   Int      @default(0)
  adultFemale Int      @default(0)
  boy         Int      @default(0)
  girl        Int      @default(0)
  infant      Int      @default(0)
  pet         Int      @default(0)
  other       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  draft Draft @relation(fields: [draftId], references: [id])
}

/// GenerationJob tracks AI generation lifecycle; only one queued/running per Draft (AR-6, ER-3 multi-run guard).
model GenerationJob {
  id          String              @id @default(uuid())
  draftId     String
  status      GenerationJobStatus
  retryCount  Int                 @default(0)
  partialDays Int[]               @default([])
  targetDays  Int[]               @default([])
  model       String?
  temperature Float?
  promptHash  String?
  startedAt   DateTime?
  finishedAt  DateTime?
  itineraryId String?
  error       String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  draft     Draft    @relation(fields: [draftId], references: [id])
  audits    AiGenerationAudit[]
  itinerary Itinerary? @relation("GenerationJobItinerary", fields: [itineraryId], references: [id])

  // Enforces at most one queued/running per draft (multi-run prevention, basic-design §5.2 / ER-3).
  @@index([draftId, status])
  // Status index supports polling by state (AR-7 list/polling use).
  @@index([status])
  // Reuse successful generations when same inputs (draftId+model+temperature+promptHash) per requirements AI-5.
  @@unique([draftId, model, temperature, promptHash])
  // One-to-one optional link to created itinerary; keep FK on GenerationJob side and ensure uniqueness.
  @@unique([itineraryId])
}

/// AiGenerationAudit is append-only audit log for every LLM call (requirements AI-4 / DB-3).
model AiGenerationAudit {
  id            String              @id @default(uuid())
  jobId         String
  correlationId String
  prompt        String?
  request       Json?
  rawResponse   String?
  parsed        Json?
  status        GenerationJobStatus
  retryCount    Int                 @default(0)
  errorMessage  String?
  model         String?
  temperature   Float?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  job GenerationJob @relation(fields: [jobId], references: [id])

  // Indexed for job timeline queries (db-structure.md §2.5).
  @@index([jobId, createdAt])
}

/// Itinerary is normalized travel plan; version supports optimistic locking in PATCH /itineraries/:id (409 VERSION_CONFLICT per AR-9/ER-3).
model Itinerary {
  id              String            @id @default(uuid())
  userId          String
  draftId         String
  title           String
  version         Int               @default(1)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  user          User          @relation(fields: [userId], references: [id])
  draft         Draft         @relation(fields: [draftId], references: [id])
  generationJob GenerationJob? @relation("GenerationJobItinerary")
  days          ItineraryDay[]
  raw           ItineraryRaw?

  // Listing by user with recency (db-structure.md indexes).
  @@index([userId, createdAt])
  // Join to Draft provenance (analysis/cleanup).
  @@index([draftId])
}

/// ItineraryDay expresses per-day slice; unique (itineraryId, dayIndex) enforces day ordering (basic-design §5.2).
model ItineraryDay {
  id          String    @id @default(uuid())
  itineraryId String
  dayIndex    Int
  date        DateTime
  scenario    DayScenario @default(SUNNY)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  itinerary Itinerary @relation(fields: [itineraryId], references: [id])
  activities Activity[]

  @@unique([itineraryId, dayIndex, scenario])
}

/// Activity stores ordered items within a day; (itineraryDayId, orderIndex) unique keeps stable ordering (requirements DB-1, basic-design §5.2).
model Activity {
  id             String       @id @default(uuid())
  itineraryDayId String
  time           String
  location       String
  content        String
  url            String?
  weather        Weather
  orderIndex     Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  day ItineraryDay @relation(fields: [itineraryDayId], references: [id])

  @@unique([itineraryDayId, orderIndex])
  // Supports ordered fetch within a day (list screen rendering).
  @@index([itineraryDayId, orderIndex])
}

/// ItineraryRaw keeps raw LLM JSON for audit/re-parse; deletion forbidden by policy (db-structure.md §2.9).
model ItineraryRaw {
  id          String   @id @default(uuid())
  itineraryId String   @unique
  rawJson     Json
  promptHash  String
  model       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  itinerary Itinerary @relation(fields: [itineraryId], references: [id])

  // NOTE: CHECK jsonb_typeof(rawJson)='object' must be enforced in service layer; Prisma has no portable CHECK support.
}

