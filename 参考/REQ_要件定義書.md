# kubell コーディング課題 要件定義書

## 0. ドキュメント情報

### 0-1. ドキュメント目的
本プロジェクトは技術面接の課題のため、小林聖弥のみが作成・利用するものであるが、実務の開発を意識し、チームでの開発時にも利用できるような形式で作成する。

### 対象読者
- 小林聖弥（開発者）
- 技術面接官（レビュアー）

## 1. プロジェクト概要

- **プロジェクト名**：映画料金最適化・予約候補提示システム
- **作成者名**：小林聖弥
- **作成日**：2025年11月20日

### 概要

本プロジェクトでは、映画館の料金を最適化し、必要に応じて **予約候補となる上映回** を特定できるシステムを開発する。

ユーザーは参加者の構成（一般／未成年／シニア）と現在日時を入力することで、現在日時以降の映画上映スケジュールから **最も安く観覧できる上映日時と料金** の提案を受ける。  

本要件定義書では、将来的に **予約情報（Reservation）の生成や残席整合性の確保** まで行う拡張案も含めて整理する。ただし、今回のコーディング課題における実装スコープは **「料金シミュレーション（最適な上映回と料金の算出）」まで** とし、管理システム、予約処理は **設計レベルでの整理（実装は対象外）** とする。

---

## 2. 利用対象・想定ユーザー

- **利用対象**：映画館の利用者、および将来的には映画館運営側（料金・スケジュール管理者）
- **想定ユーザー**：
  - 映画館を訪れる個人客
  - グループで映画鑑賞を計画しているユーザー
  - 家族連れで映画を楽しむユーザー
  - （将来）上映スケジュールや料金を管理する映画館スタッフ

---

## 3. 要件一覧（優先度: MUST/SHOULD/COULD）

### 3-1. 機能要件一覧（今回スコープ中心）

> ※F1〜F20 は主に「料金シミュレーター／管理機能」まで。  
> 予約・座席関連（Reservation, Seat）は **3-3. 将来拡張要件** に分離。

| 要件ID | 画面ID | 画面名                      | カテゴリ         | 要件名(中分類)           | 要件名(小分類)                      | 説明                                                                                                                         | 優先度 |
|--------|--------|-----------------------------|------------------|--------------------------|--------------------------------------|------------------------------------------------------------------------------------------------------------------------------|--------|
| F1     | P1     | 料金シミュレーター画面      | 入力             | 参加者情報入力           | 大人・未成年・シニア入力            | 一般・未成年・シニアの人数を入力できる。PG 指定に関わる 15歳未満／12歳未満フラグはクラス図上にのみ保持し、今回実装は行わない。 | MUST   |
| F2     | P1     | 料金シミュレーター画面      | 入力             | 現在日時入力             | 日時フォーム入力                    | 現在日時を入力（または自動取得）し計算に使用する。`検索条件.現在日時` にマッピングされる。                                   | MUST   |
| F3     | -      | -                           | データ参照       | 上映スケジュール参照     | 残席数含む一覧                      | 事前定義された上映スケジュール（`上映回`）と残席数を計算対象として参照する。`上映回.作品ID` はクラス図には存在するが今回ロジックでは未使用。 | MUST   |
| F4     | -      | -                           | ドメイン         | 料金計算                 | 人単位料金計算                      | `料金計算サービス` が `料金ルール` と `割引条件` を用いて参加者ごとに最安料金を算出する。                                     | MUST   |
| F5     | -      | -                           | ドメイン         | 料金計算                 | 合計料金計算                        | 全参加者の最安料金を合計し、上映回ごとの総額を算出する。`最安料金計算(上映回, 観覧団体)` に対応。                             | MUST   |
| F6     | -      | -                           | ドメイン         | 最適上映回選択           | 最安値優先＋日時優先                | `料金計算サービス.最適プラン検索` で、最安の上映回を選び、同額の場合は最も早い時間の上映を選択する。                        | MUST   |
| F7     | P1     | 料金シミュレーター画面      | 出力             | 結果表示                 | 最適上映回表示                      | 算出された最安上映日時と合計料金（`最適プラン結果`）を画面に表示する。                                                       | MUST   |
| F8     | P1     | 料金シミュレーター画面      | 出力             | 結果表示                 | 条件不一致メッセージ                | 条件を満たす上映回がない場合、`最適プラン結果.利用可能 = false` とし、その理由をメッセージ表示する。                         | MUST   |
| F9     | P1     | 料金シミュレーター画面      | 出力             | 結果表示（任意）         | 料金内訳表示                        | 区分ごとの人数・単価・合計の内訳を表示（`料金ルール` 適用結果の可視化）。任意機能として扱う。                               | SHOULD |
| F10    | P1     | 料金シミュレーター画面      | バリデーション   | 入力値バリデーション     | 人数形式チェック                    | 入力した人数が 0 以上かつ整数であることをチェック。UI 層の責務とし、ドメイン層には不正値を渡さない。                        | SHOULD |
| F11    | P1     | 料金シミュレーター画面      | バリデーション   | 入力値バリデーション     | 現在日時形式チェック                | 日付形式が正当でない場合、計算を実施せずエラーとして扱う。                                                                  | SHOULD |
| F12    | P2     | 管理ダッシュボード          | 認証・認可       | 管理者ログイン           | 管理者認証                          | **本来MUST（運用前提）だが課題では省略可**。管理機能にアクセス制御を設ける設計のみ行い、実装は対象外。                     | COULD  |
| F13    | P2     | 管理ダッシュボード          | ナビゲーション   | 管理メニュー表示         | 管理画面リンク一覧                  | 料金・割引・上映管理ページへの導線を持つメニュー構造を設計。画面実装は今回対象外。                                           | COULD  |
| F14    | P2-1   | 通常料金設定画面            | マスタ管理       | 料金マスタ管理           | 通常料金の参照・更新                | 通常料金（`料金ルール` のうち標準料金）を管理画面から更新できる前提の設計。課題では定数定義で代替し実装対象外。             | COULD  |
| F15    | P2-1   | 通常料金設定画面            | バリデーション   | 管理画面入力チェック     | 料金入力チェック                    | 管理画面での料金入力値の妥当性チェック。将来の運用要件として設計のみ行い、今回実装は行わない。                             | COULD  |
| F16    | P2-2   | 割引ルール管理画面          | マスタ管理       | 割引ルール管理           | 割引条件・金額の参照・更新          | `料金ルール` と `割引条件` を管理画面から参照・更新できる構造を設計。実サービスでは MUST だが、本課題では定数運用とし実装対象外。 | COULD  |
| F17    | P2-2   | 割引ルール管理画面          | バリデーション   | 管理画面入力チェック     | 割引設定整合性チェック             | 条件と料金の整合性確認（例：範囲被り、あり得ない金額など）。クラス図上の拡張ポイントとして設計のみ。                       | COULD  |
| F18    | P2-3   | 上映スケジュール管理画面    | マスタ管理       | 上映スケジュール管理     | 日時・残席数の参照・更新            | `上映回` の日時・初期座席数・残席数を管理画面から更新できる構造を設計。課題では静的データ前提で実装対象外。                | COULD  |
| F19    | P2-3   | 上映スケジュール管理画面    | マスタ管理       | 上映スケジュール追加     | 新規上映追加                        | 新規 `上映回` を追加する運用フロー（作品選択＋日時＋座席数）を設計。将来拡張前提で、今回実装不要。                         | COULD  |
| F20    | P2-3   | 上映スケジュール管理画面    | バリデーション   | 管理画面入力チェック     | 日時・残席形式チェック             | 上映作成・更新時の日時・座席数形式チェック。元々は MUST だが、静的データ前提のため設計のみ。                               | COULD  |

---

### 3-2. 非機能要件一覧（Non-Functional Requirements）

| 要件ID | カテゴリ       | 要件名                   | 説明                                                                                                                                             | 指標例                                           | 優先度 | 対象範囲                            |
|--------|----------------|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|--------|-------------------------------------|
| N1     | 拡張性         | 割引ルール追加容易性     | 割引ロジックは `料金ルール` と `割引条件`（インターフェース実装クラス）を追加することで拡張可能とし、`料金計算サービス` の既存コードを書き換えずに拡張できる構造にする。PG 条件や曜日条件はクラス図上に拡張ポイントとして用意するが、今回実装は行わない。 | 新たな割引条件追加時に `料金計算サービス` の既存関数を書き換えない                                      | SHOULD | 設計のみ（実装は最小限）           |
| N2     | 保守性         | ドメインとUIの分離       | UI コンポーネントとは別に、`料金計算サービス`・`料金ルール`・`割引条件`・`上映回` などのドメインロジックを `domain/` 等の層に分離し再利用性を高める。 | UI 内にビジネスロジック記述なし                  | MUST   | 今回実装対象                       |
| N3     | 性能           | レスポンス性能           | 計算処理（`最適プラン検索`）は 100ms 以内に返す（クライアントのみの処理前提）。割引条件の数や上映回数を考慮しても十分に高速なアルゴリズムとする。   | ローカル環境で 100ms 以下                        | SHOULD | 今回実装対象                       |
| N4     | スケーラビリティ | 将来のAPI化を前提        | 料金計算を副作用のない関数（例：`calculateBestPlan(input: JSON): JSON`）として切り出せる設計とし、将来的に API 化しやすい構造にする。 | `料金計算サービス` のメソッドは純粋関数に近く、副作用は外部 I/O に委譲                                | SHOULD | 設計のみ（実装は現在の関数単位）   |
| N5     | セキュリティ   | 入力検証（利用者向け）   | 人数・日時・区分は UI 側でバリデーションし、不正値をドメインに渡さない。PG 条件用のフラグなど拡張項目は将来導入時に同様の検証を行う前提。       | 不正値入力時は submit 不可                       | MUST   | 今回実装対象                       |
| N6     | セキュリティ   | 管理画面アクセス制御     | 管理画面（料金／割引／上映管理）は URL 直打ち不可な設計とし、将来の認証・認可導入を見据える。                                                   | `admin/*` を保護し公開ルートから分離             | SHOULD | 将来運用前提（今回実装外、設計のみ） |
| N7     | 運用性         | ログ設計                 | エラー・計算結果などをアプリケーションログとして記録できるようにし、将来の障害解析や利用状況分析に活用できる構造とする（本課題では開発用ログレベルでの想定）。           | `最適プラン検索` の入力・出力が何らかのログとして記録可能であること | COULD  | 今回実装対象（軽微、方式は基本設計で詳細化） |
| N8     | テスト容易性   | 単体テスト可能な構造     | `料金ルール`／`割引条件`／`料金計算サービス`／`上映回` は副作用なしで単体テスト可能な設計とし、PG 条件・曜日条件など将来の拡張も同様にテスト容易とする。 | Vitest で自動テスト可能                            | SHOULD | 今回実装対象（テスト実装は任意）   |
| N9     | 信頼性         | 同じリクエストを繰り返しても結果が変わらない設計（管理系）         | 将来の API や管理画面からのマスタ更新では、同一リクエストを複数回実行しても結果が変わらないよう配慮する。現在の課題スコープでは設計レベルの意識のみとする。 | 将来の API 設計時に PUT/POST など HTTP メソッドの意味付けを明確化できること | SHOULD | 将来運用前提（今回実装外、設計のみ） |
| N11    | 一貫性         | 予約候補の一貫性         | `予約`（Reservation）生成後は料金・残席を固定値として扱い、後続処理で再計算しない設計とする（F28 と連動）。クラス図上の予約システムとしてのみ定義。 | `予約` 生成後に料金フィールドを書き換えない      | SHOULD | 将来運用前提（今回実装外、設計のみ） |

---

### 3-3. 将来拡張要件（Reservation／座席関連など・参考）

> ※本課題スコープ外（Reservation 生成・座席指定など）だが、ドメインモデル上はあらかじめ考慮しておく将来拡張要件。

| 要件ID | 画面ID | 画面名                      | カテゴリ         | 要件名(中分類)         | 要件名(小分類)                        | 説明                                                                                                                                             | 優先度 |
|--------|--------|-----------------------------|------------------|------------------------|----------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|--------|
| F21    | P3     | 予約確認画面                | 入力             | 予約内容確認           | 予約候補の最終確認                    | 最適上映回と料金を元に、上映日時・人数・料金をまとめて確認し「予約候補として確定」する UI を将来提供する設計。今回実装外。                     | COULD  |
| F22    | -      | -                           | ドメイン         | 予約生成               | 予約（Reservation）作成               | `顧客`・`上映回`・`観覧団体`・料金から `予約` エンティティを生成する。クラス図上の予約システムとして設計のみ（未実装）。                       | COULD  |
| F23    | -      | -                           | ドメイン         | 座席整合性確認         | 残席数確認                            | `予約` 生成時に、対象 `上映回.残席数` が団体人数以上であることを `上映回.予約可能か()` で確認する設計。実装は対象外。                        | COULD  |
| F24    | -      | -                           | バリデーション   | 制約再チェック         | 未成年・時間帯制約の再判定            | 予約生成前に「未成年は 20 時以降不可」など PG・時間帯制約を再判定する仕組みを設計。PG 用の年齢フラグはクラス図上のみで未実装。              | COULD  |
| F25    | P4     | 予約候補完了画面            | 出力             | 結果表示               | 予約候補情報表示                      | 予約ID（仮）、上映日時、参加者構成、料金など `予約` 情報を表示する画面を将来用意する設計。今回実装対象外。                                   | COULD  |
| F26    | -      | -                           | 永続化（将来）   | 予約情報保存           | 予約情報の保存                        | 将来拡張として、`予約` を DB 等に永続化できる構造（リポジトリ層など）を設計。今回実装外。                                                     | COULD  |
| F27    | -      | -                           | バリデーション   | 重複予約対策           | 多重確定防止                          | 同一入力で連続して確定が押された場合でも二重に `予約` が生成されないようにする設計（同じ操作を繰り返しても結果が変わらないようにする）。実装は対象外。                                  | COULD  |
| F28    | -      | -                           | ドメイン         | 料金確定               | 計算結果固定                          | `予約` 生成後は料金計算結果を確定値として扱い、後続処理で変更しない設計（N11 と連動）。今回実装外。                                           | SHOULD |
| F29    | -      | -                           | セキュリティ     | 利用者識別（将来）     | 予約とユーザーの紐付け                | 予約履歴管理を行う場合に備え、ユーザー識別（顧客ID 等）と `予約` を紐付けられるようにする設計。クラス図上の `顧客` と対応。                   | COULD  |
| F30    | P2-4   | 座席レイアウト管理画面      | マスタ管理       | 座席レイアウト管理     | スクリーンごとの座席配置管理          | 将来拡張として、スクリーン単位で「列」「座席番号」「座席種別（通常席・車椅子席など）」を管理できる `座席(Seat)` マスタを持つ構造を設計する。今回実装は行わず、クラス図上の拡張ポイントとしてのみ扱う。 | COULD  |
| F31    | -      | -                           | ドメイン         | 座席選択ロジック       | 連番・孤立席抑止などの制約             | `予約` と `座席` を紐付ける `座席予約(SeatReservation)` を導入し、将来的には「指定席」「連番席の確保」「1席だけ空席を残さない」といった座席配置ルールを表現できるようにする。今回実装は座席“数”のみ。 | COULD  |
| F32    | P3     | 予約確認画面                | 入力／出力       | 座席位置の選択・表示   | 予約時の座席指定 UI                    | 予約候補を確定する際に、座席レイアウトから具体的な座席位置を選択・表示できる UI を将来提供する前提で設計する。現段階では人数ベースの予約のみを実装対象とし、座席指定はサポートしない。             | COULD  |

---

### 優先度の基準（課題提出スコープ考慮版）

- **MUST（提出範囲）**  
  今回の課題（フロント実装）で最低限実装する要件。主に料金シミュレーションに関する部分。

- **SHOULD（本来必須だが提出では省略可）**  
  余裕があれば実装したい要件。主に保守性・拡張性・将来の運用を見据えた要件。

- **COULD（将来拡張 or 設計のみ反映）**  
  実際のプロダクト開発ではMUSTとなるが、今回の課題スコープ（料金シミュレーター中心）により実装対象外となりうる要件。実装しなくてもよいが設計資料や解説で触れると望ましい要件。

---

## 4. システム構成

- **フロントエンド**：
  - 技術スタック：React, TypeScript, Vite, Tailwind CSS, Zod
  - 役割：
    - ユーザーインターフェースの提供
    - 参加者情報・現在日時の入力受付
    - 料金計算ロジック（ドメイン層への委譲を含む）の実行
    - 最適上映回と料金の表示
    - （設計レベル）予約候補情報の表示
  - 備考：本課題ではフロントエンドのみ実装対象とし、Reservation生成はフロント側のドメインオブジェクトとして扱う想定

- **バックエンド（将来拡張）**：
  - 技術スタック：Node.js, Express（将来のAPI化を見据えた設計）
  - 役割：
    - 将来的な料金計算APIの提供
    - 料金マスタ・割引ルール・上映スケジュールの取得API
    - 管理画面からの更新リクエスト受付
    - Reservationの永続化・整合性チェック
  - 備考：今回のコーディング課題では実装せず、**API化前提のI/O設計** のみを意識する

- **データベース（将来拡張）**：
  - 技術スタック：PostgreSQL（将来の拡張を見据えた設計）
  - 役割：
    - 料金マスタ、割引ルール、上映スケジュールの管理
    - Reservation（予約情報）の永続化
  - 備考：今回の課題では、料金・割引・上映スケジュール・Reservationはいずれも **フロント側の定数 or メモリ内オブジェクト** として扱う

---

## 5. 外部インタフェース要件（入出力仕様）

本仕様は **「料金シミュレーター機能」中心**。
管理機能・予約機能は設計のみ / 今回実装対象外。

---

### 5-1. 入力仕様（実装範囲）

| 入力項目         | データ型   | 必須/任意 | 説明                                     | バリデーション条件                      |
|------------------|------------|-----------|------------------------------------------|----------------------------------------|
| 大人の人数       | 整数(int)  | 必須      | 映画鑑賞に参加する大人の人数             | 0以上 / 整数                           |
| 未成年の人数     | 整数(int)  | 必須      | 映画鑑賞に参加する未成年の人数           | 0以上 / 整数                           |
| シニアの人数     | 整数(int)  | 必須      | 映画鑑賞に参加するシニアの人数           | 0以上 / 整数                           |
| 現在日時         | DateTime   | 必須      | 割引判定に使用                           | valid datetime                         |

**補足**

- UI 入力は人数ベースだが、内部では `観覧団体 → 参加者リスト(List<参加者>)` に変換して計算  
- 今回は **PG指定（R15 / PG12 等）による入場制限は未実装**  
  → クラス図上は判定できる属性を付与済だがロジック未搭載

---

### 5-2. 入力仕様（設計のみ / 今回未実装）

| 入力項目               | データ型     | 説明                                                                      | 状態       |
|------------------------|--------------|---------------------------------------------------------------------------|------------|
| 選択上映回ID           | int/String   | 最適上映回が提示された後、予約候補として確定するための上映識別子         | 将来拡張   |
| 座席位置選択(複数)     | List<SeatID> | 個別席の指定／連番確保／孤立席抑止などの座席選択                        | 将来拡張   |
| 利用者ID（顧客識別）   | String/UUID  | 予約を利用者に紐付けるための識別子                                       | 将来拡張   |

**座席は数のみ扱う → 今回は Seat クラス（座席位置）未実装（COULD）のため、グループが離れてしまう可能性あり。**  
**座席位置をスコープに入れるとあまりにも複雑になるため、今回は人数ベースの予約のみを扱う。**

---

### 5-3. 出力仕様（実装範囲）

| 出力項目       | データ型     | 説明                                                                      | 状態 |
|----------------|--------------|---------------------------------------------------------------------------|------|
| 最適上映日時   | DateTime     | 最も安い上映日時（同額なら時間が早い方）                                 | 必須 |
| 合計料金       | 数値(int)    | 団体全体の合計料金                                                       | 必須 |
| 料金内訳       | List<Object> | 区分ごとの人数・単価・合計の内訳（COULDだが返せる構造にしておく）       | 任意 |
| 利用可能フラグ | bool         | 利用可否（上映がない等の場合は false）                                   | 必須 |
| 不可理由       | String       | 利用不可の場合、制約理由を説明                                          | 任意 |

---

### 5-4. 出力仕様（設計のみ / 今回未実装）

| 出力項目      | データ型          | 説明                                                                 | 状態   |
|---------------|-------------------|----------------------------------------------------------------------|--------|
| 予約候補ID    | String / UUID     | `Reservation`（仮）を識別するID。今回は生成のみ設計レベルで想定。   | 将来拡張 |
| 予約候補詳細  | Object            | 上映回、料金、人数、観覧団体構成などの予約候補情報をまとめたオブジェクト。 | 将来拡張 |
| 座席割当結果  | List<SeatID>      | 指定席の場合の座席配置。連番保証や孤立席抑止などのルールを反映した結果。 | 将来拡張 |
| 注意事項リスト| List<String>      | 「未成年は20時以降不可」など、予約確定前にユーザーへ提示すべき制約事項。 | 将来拡張 |

---

### 5-5. スコープ外の補足

| 領域         | 今回の扱い                             | 将来の改善案                                                                                 |
|--------------|----------------------------------------|----------------------------------------------------------------------------------------------|
| 座席         | **座席“数”のみ扱う**（位置情報なし）   | `Seat` / `SeatReservation` クラスを導入し、レイアウト・連番・孤立席などを管理               |
| レーティング判定 | `作品` に属性を保持するがロジック未実装 | `AgeCondition` と統合し、PG12/R15 などの入場制限ロジックを実装                             |
| 管理UI       | クラス図上には存在するが UI 実装なし    | 管理者権限・ログイン、料金／割引／上映マスタの CRUD 画面を実装                               |
| 料金ルール変更| コード内に静的定義（定数として保持）    | 料金マスタ・割引条件マスタをDB等に切り出し、運用で変更可能にする                            |

---

## 6. 異常系・エラー処理要件

| 想定されるエラー                     | 対応方法                                                          |
|--------------------------------------|-------------------------------------------------------------------|
| 無効な入力（人数が負の数、非整数など） | 入力バリデーションエラーを表示し、再入力を促す                    |
| 日付形式エラー                       | エラーメッセージを表示し、正しい形式での入力を促す              |
| 条件を満たす上映回がない             | 「条件を満たす上映回がありません」と表示する                    |
| （将来）予約候補生成時の残席不足     | 「予約候補生成中に残席不足になりました」と表示し、再計算を促す  |
| （将来）未成年の時間帯制約違反       | 「未成年は20時以降の回を選択できません」と表示する              |
| システムエラー                       | 一般的なエラーメッセージを表示し、再試行を促す                  |


## 7. 開発プロセス方針（参考）

> ※コーディング課題としての必須要件ではなく、「開発プロセスに関する方針」として参考記載。

- **CI/CD（自動テスト & ビルド）方針**
  - プロジェクトとしては、将来的に PR 時に「テスト → ビルド → 静的チェック」が自動実行される構成を採用することを想定する。
  - そのために、ドメイン層（`料金計算サービス` など）はフレームワークへの依存を最小限とし、テストコードやビルドパイプラインから独立して扱いやすい構造とする。
  - 具体的な CI/CD ツール（例：GitHub Actions）の設定や導入は、本課題ではスコープ外とする。

- **コード品質管理方針**
  - コード品質を維持するために、以下の方針を採用する。
    - 静的型付け言語（TypeScript）を使用し、型安全性を確保する。
    - コードレビューを実施し、ベストプラクティスやコーディング規約の遵守を確認する。
    - 自動テスト（ユニットテスト、統合テスト）を導入し、主要なロジックの動作保証を行う。
    - リンター（例：ESLint）やフォーマッター（例：Prettier）を使用し、一貫したコードスタイルを維持する。
  - これらの方針により、コードの可読性、保守性、信頼性を高めることを目指す。
